# UpDesk Apache Configuration
# Optimized for high performance with direct static file serving

ServerTokens Prod
ServerSignature Off
TraceEnable Off

# Performance Tuning
Timeout 60
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# Enable required modules (loaded via httpd.conf)
# - mod_rewrite: URL rewriting for SPA
# - mod_headers: Cache headers
# - mod_expires: Expiration headers
# - mod_deflate: Gzip compression
# - mod_proxy: Reverse proxy
# - mod_proxy_http: HTTP proxy
# - mod_http2: HTTP/2 support

# HTTP Server (Port 80)
<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /usr/local/apache2/htdocs

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # Enable HTTP/2
    Protocols h2 h2c http/1.1

    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Gzip Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
        AddOutputFilterByType DEFLATE application/javascript application/json application/xml
        AddOutputFilterByType DEFLATE image/svg+xml
        
        # Don't compress images, videos, or already compressed files
        SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|ico|mp4|webm|woff2?)$ no-gzip
        
        # Browser compatibility
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        BrowserMatch ^Mozilla/4\.0[678] no-gzip
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    </IfModule>

    # ==========================================
    # API Requests → Backend (Reverse Proxy)
    # ==========================================
    <Location /api>
        ProxyPreserveHost On
        ProxyPass http://updesk:5002/api
        ProxyPassReverse http://updesk:5002/api
        
        # No caching for API requests
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
        
        # Proxy timeout settings
        ProxyTimeout 300
    </Location>

    # ==========================================
    # Static Assets → Direct Serving (FAST!)
    # ==========================================
    
    # JavaScript, CSS, Fonts, Images with content hash
    # These files have content-based names (e.g., app.abc123.js)
    # Safe to cache for 1 year
    <LocationMatch "^/assets/.*\.(js|css|woff2?|ttf|eot|otf|svg|png|jpg|jpeg|gif|webp|ico)$">
        # Serve from local filesystem (no proxy!)
        # Files are in DocumentRoot (/usr/local/apache2/htdocs)
        
        # Aggressive caching (1 year)
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
        </IfModule>
        
        Header set Cache-Control "public, immutable, max-age=31536000"
        
        # CORS headers (if needed for CDN)
        Header set Access-Control-Allow-Origin "*"
        
        # Disable ETags (not needed with immutable cache)
        FileETag None
    </LocationMatch>

    # Specific handling for /assets/ directory
    <Directory "/usr/local/apache2/htdocs/assets">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Aggressive caching
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
        </IfModule>
        
        Header set Cache-Control "public, immutable, max-age=31536000"
    </Directory>

    # ==========================================
    # SPA Routing (Vue Router)
    # ==========================================
    
    # Root directory configuration
    <Directory "/usr/local/apache2/htdocs">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Enable URL rewriting
        RewriteEngine On
        
        # If file exists, serve it directly
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteRule ^ - [L]
        
        # If directory exists, serve it directly
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        
        # If API request, skip (handled by ProxyPass above)
        RewriteCond %{REQUEST_URI} ^/api
        RewriteRule ^ - [L]
        
        # Everything else → index.html (SPA fallback)
        RewriteRule ^ /index.html [L]
    </Directory>

    # index.html - Short cache (check for updates)
    <Files "index.html">
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 5 minutes"
        </IfModule>
        
        Header set Cache-Control "public, max-age=300, must-revalidate"
    </Files>

    # favicon.ico - Medium cache
    <Files "favicon.ico">
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 week"
        </IfModule>
        
        Header set Cache-Control "public, max-age=604800"
    </Files>

    # ==========================================
    # Security & Performance
    # ==========================================
    
    # Deny access to hidden files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    # Deny access to sensitive files
    <FilesMatch "\.(env|log|sql|sqlite|db)$">
        Require all denied
    </FilesMatch>

</VirtualHost>

# HTTPS Server (Port 443)
<VirtualHost *:443>
    ServerName localhost
    DocumentRoot /usr/local/apache2/htdocs

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /usr/local/apache2/ssl/cert.pem
    SSLCertificateKeyFile /usr/local/apache2/ssl/key.pem
    
    # Modern SSL Configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on
    
    # Enable HTTP/2
    Protocols h2 http/1.1

    # HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Gzip Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
        AddOutputFilterByType DEFLATE application/javascript application/json application/xml
        AddOutputFilterByType DEFLATE image/svg+xml
        
        SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|ico|mp4|webm|woff2?)$ no-gzip
        
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        BrowserMatch ^Mozilla/4\.0[678] no-gzip
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    </IfModule>

    # ==========================================
    # API Requests → Backend (Reverse Proxy)
    # ==========================================
    <Location /api>
        ProxyPreserveHost On
        ProxyPass http://updesk:5002/api
        ProxyPassReverse http://updesk:5002/api
        
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
        
        ProxyTimeout 300
    </Location>

    # ==========================================
    # Static Assets → Direct Serving (FAST!)
    # ==========================================
    
    <LocationMatch "^/assets/.*\.(js|css|woff2?|ttf|eot|otf|svg|png|jpg|jpeg|gif|webp|ico)$">
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
        </IfModule>
        
        Header set Cache-Control "public, immutable, max-age=31536000"
        Header set Access-Control-Allow-Origin "*"
        FileETag None
    </LocationMatch>

    <Directory "/usr/local/apache2/htdocs/assets">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
        </IfModule>
        
        Header set Cache-Control "public, immutable, max-age=31536000"
    </Directory>

    # ==========================================
    # SPA Routing (Vue Router)
    # ==========================================
    
    <Directory "/usr/local/apache2/htdocs">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        RewriteEngine On
        
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteRule ^ - [L]
        
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        
        RewriteCond %{REQUEST_URI} ^/api
        RewriteRule ^ - [L]
        
        RewriteRule ^ /index.html [L]
    </Directory>

    <Files "index.html">
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 5 minutes"
        </IfModule>
        
        Header set Cache-Control "public, max-age=300, must-revalidate"
    </Files>

    <Files "favicon.ico">
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 week"
        </IfModule>
        
        Header set Cache-Control "public, max-age=604800"
    </Files>

    # ==========================================
    # Security
    # ==========================================
    
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    <FilesMatch "\.(env|log|sql|sqlite|db)$">
        Require all denied
    </FilesMatch>

</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet